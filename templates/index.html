<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Рекомендації щодо інфраструктури міста</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <style>
      #map {
        height: 500px;
        width: 100%;
        margin-top: 20px;
      }
      #analytics-panel {
        padding: 10px;
        margin-top: 20px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
      }
      #analytics-table {
        width: 100%;
        border-collapse: collapse;
      }
      #analytics-table th,
      #analytics-table td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>Рекомендаційна система інфраструктури міста</h1>

    <label for="city">Виберіть місто:</label>
    <select id="city" onchange="getRecommendation(); getAnalytics();">
      <option value="Kyiv, Ukraine">Київ</option>
      <option value="Lviv, Ukraine">Львів</option>
      <option value="Odesa, Ukraine">Одеса</option>
      <option value="Dnipro, Ukraine">Дніпро</option>
      <option value="Kharkiv, Ukraine">Харків</option>
      <option value="Zaporizhzhia, Ukraine">Запоріжжя</option>
    </select>

    <label for="category">Виберіть категорію:</label>
    <select id="category">
      <option value="school">Школи</option>
      <option value="hospital">Лікарні</option>
      <option value="park">Парки</option>
      <option value="restaurant">Ресторани</option>
      <option value="pharmacy">Аптеки</option>
      <option value="gym">Спортивні комплекси</option>
      <option value="library">Бібліотеки</option>
      <option value="mall">Торгові центри</option>
    </select>

    <button onclick="getRecommendation()">Отримати рекомендацію</button>
    <p id="recommendation"></p>

    <button onclick="sendFeedback('підтвердити')">Підтвердити</button>
    <button onclick="sendFeedback('відхилити')">Відхилити</button>

    <div id="map"></div>

    <div id="analytics-panel">
      <h2>Аналіз інфраструктури</h2>
      <p>Населення: <span id="population"></span></p>
      <p>Площа (км²): <span id="area"></span></p>

      <table>
        <thead>
          <tr>
            <th>Категорія</th>
            <th>Кількість</th>
            <th>На 100,000 населення</th>
            <th>Норма на 100,000</th>
          </tr>
        </thead>
        <tbody id="analytics-body"></tbody>
      </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
      let map;
      let markers = [];

      function initMap() {
        map = L.map("map").setView([50.4501, 30.5234], 12);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);
      }

      function getRecommendation() {
        const category = document.getElementById("category").value;
        const city = document.getElementById("city").value;

        markers.forEach((marker) => map.removeLayer(marker));
        markers = [];

        fetch("/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ category: category, city: city }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("recommendation").innerText =
              data.recommendation;
            updateMap(data.locations);
            centerMapOnCity(city);
          });
      }

      function updateMap(locations) {
        markers.forEach((marker) => map.removeLayer(marker));
        markers = [];

        locations.forEach((location) => {
          if (location.lat && location.lon) {
            const marker = L.marker([location.lat, location.lon]).addTo(map);
            marker.bindPopup(location.name).openPopup();
            markers.push(marker);
          }
        });
      }

      function centerMapOnCity(city) {
        const cityCoordinates = {
          "Kyiv, Ukraine": [50.4501, 30.5234],
          "Lviv, Ukraine": [49.8397, 24.0297],
          "Odesa, Ukraine": [46.4825, 30.7233],
          "Dnipro, Ukraine": [48.4647, 35.0462],
          "Kharkiv, Ukraine": [49.9935, 36.2304],
          "Zaporizhzhia, Ukraine": [47.8388, 35.1396],
        };
        map.setView(cityCoordinates[city], 12);
      }

      function sendFeedback(feedback) {
        const category = document.getElementById("category").value;
        const city = document.getElementById("city").value;

        fetch("/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: category,
            feedback: feedback,
            city: city,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("recommendation").innerText =
              data.recommendation;
          });
      }

      function getAnalytics() {
        const city = document.getElementById("city").value;

        fetch("/analytics", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ city: city }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("population").innerText = data.population;
            document.getElementById("area").innerText =
              data.area_km2.toFixed(2);

            const analyticsBody = document.getElementById("analytics-body");
            analyticsBody.innerHTML = "";

            Object.entries(data.analytics).forEach(([category, stats]) => {
              const row = document.createElement("tr");
              row.innerHTML = `<td>${category}</td><td>${stats.count}</td><td>${stats.per_capita}</td><td>${stats.norm_per_100k}</td>`;
              analyticsBody.appendChild(row);
            });
          });
      }

      document.addEventListener("DOMContentLoaded", initMap);
    </script>
  </body>
</html>
